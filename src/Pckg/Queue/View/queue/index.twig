<div class="row">
    <div class="col-md-12">
        <canvas id="myChart" width="5" height="1"
                data-chartjs="{{ chart | json_encode }}"></canvas>
    </div>
</div>

<div class="row">
    <div class="col-md-3 bg-success">
        <h2>Successful in last 24h</h2>
        <h3>{{ stat.successful24h }}</h3>
    </div>
    <div class="col-md-3 bg-primary">
        <h2>Currently running</h2>
        <h3>{{ stat.currentlyRunning }}</h3>
    </div>
    <div class="col-md-3 bg-danger">
        <h2>Failed permanently in last 24h</h2>
        <h3>{{ stat.failedPermanently24h }}</h3>
    </div>
    <div class="col-md-3 bg-danger">
        <h2>Manual execution</h2>
        <h3>{{ manualQueue.count() }}</h3>
    </div>
</div>

<div class="#vue-pckg-queue-table">
    <script type="text/x-template" id="pckg-queue-table">
        <div>
        <h3>${ table } (${ queues.length })</h3>
        <table class="table table-condensed table-stripped" v-if="queues.length">
            <tr>
                <th>ID</th>
                <th>Created at</th>
                <th>Execute at</th>
                <th>Started at</th>
                <th>Finished at</th>
                <th>Log</th>
                <th>Command</th>
                <th>Status</th>
                <th v-if=manual></th>
            </tr>
            <tr v-for="queue in queues" v-bind:class="getClass(queue)">
                <td>${ queue.id }</td>
                <td>${ queue.created_at }</td>
                <td>${ queue.execute_at }</td>
                <td>${ queue.started_at }</td>
                <td>${ queue.finished_at }</td>
                <td v-bind:title="queue.log">${ queue.shortLog }</td>
                <td v-bind:title="queue.command">${ queue.shortCommand }</td>
                <td>${ queue.executions } / ${ queue.retries } / ${ queue.progress }% / ${ queue.status }</td>
                <td v-if="manual"><a href="#" class="btn btn-xs"><i class="fa fa-play"></i></a></td>
            </tr>
            <template v-if="queue.logs">
                <tr v-for="log in queue.logs">
                    <td>${ log.id }</td>
                    <td>${ log.datetime }</td>
                    <td>${ log.log }</td>
                    <td>${ queue.progress }% / ${ log.status }</td>
                </tr>
            </template>
        </table>
        <p v-else>No jobs, no working =)</p>
        </div>
    </script>

    <script type="text/javascript">
        data.currentQueue = {{ currentQueue.toJSON() | raw }};
        data.nextQueue = {{ nextQueue.toJSON() | raw }};
        data.prevQueue = {{ prevQueue.toJSON() | raw }};
        data.startedQueue = {{ startedQueue.toJSON() | raw }};
        data.manualQueue = {{ manualQueue.toJSON() | raw }};

        Vue.component('pckg-queue-table', {
            template: '#pckg-queue-table',
            props: {
                table: null,
                queues: [],
                url: null,
                manual: false
            },
            data: function () {
                return {};
            },
            mounted: function () {
                this.$nextTick(function() {
                    setInterval(function () {
                        http.getJSON(this.url, function (json) {
                            this.queues = json;
                        }.bind(this));
                    }.bind(this), 5000);
                }.bind(this));
            },
            methods: {
                getClass: function (queue) {
                    if (queue.status == 'failed_permanently') {
                        return 'danger';
                    } else if (queue.status == 'failed') {
                        return 'warning';
                    } else if (queue.status == 'running') {
                        return 'info';
                    } else if (queue.status == 'started') {
                        return 'success';
                    } else if (queue.status == 'created') {
                        return 'text-muted';
                    }

                    return '';
                }
            }
        });
    </script>

    <pckg-queue-table :url="'/ajax/jobs/manual'" :table="'Manual jobs'"
                      :queues="manualQueue" :manual="true"></pckg-queue-table>

    <pckg-queue-table :url="'/ajax/jobs/current'" :table="'Current jobs'"
                      :queues="currentQueue"></pckg-queue-table>

    <pckg-queue-table :url="'/ajax/jobs/started'" :table="'Started jobs'"
                      :queues="startedQueue"></pckg-queue-table>

    <pckg-queue-table :url="'/ajax/jobs/next'" :table="'Next jobs'"
                      :queues="nextQueue"></pckg-queue-table>

    <pckg-queue-table :url="'/ajax/jobs/prev'" :table="'Previous jobs'"
                      :queues="prevQueue"></pckg-queue-table>
</div>